# Azure Pipelines template for deploying to Arc XP
#
# Usage in your azure-pipelines.yml:
#   - template: deploy-action/azure-templates.yml
#     parameters:
#       orgId: $(DEV_ORG_ID)
#       apiKey: $(DEV_ARC_ACCESS_TOKEN)
#       apiHostname: $(DEV_ORG_ENV_DOMAIN)
#       bundlePrefix: 'bundle'

parameters:
  - name: orgId
    displayName: Organization ID
    type: string
  - name: apiKey
    displayName: API Key
    type: string
  - name: apiHostname
    displayName: API Hostname
    type: string
  - name: bundlePrefix
    displayName: Bundle Prefix
    type: string
  - name: pagebuilderVersion
    displayName: PageBuilder Version
    type: string
    default: latest
  - name: artifact
    displayName: Artifact Path
    type: string
    default: dist/fusion-bundle.zip
  - name: retryCount
    displayName: Retry Count
    type: string
    default: '10'
  - name: retryDelay
    displayName: Retry Delay (seconds)
    type: string
    default: '5'
  - name: minimumRunningVersions
    displayName: Minimum Running Versions
    type: string
    default: '7'
  - name: terminateRetryCount
    displayName: Terminate Retry Count
    type: string
    default: '3'
  - name: terminateRetryDelay
    displayName: Terminate Retry Delay (seconds)
    type: string
    default: '10'
  - name: deploy
    displayName: Deploy
    type: boolean
    default: true
  - name: promote
    displayName: Promote
    type: boolean
    default: true

steps:
  - script: |
      if [ ! -d "deploy-action" ]; then
        git clone https://github.com/code-store-platform/deploy-action.git deploy-action
      fi
    displayName: 'Clone deploy-action if needed'
    condition: ne(variables['Build.Reason'], 'PullRequest')

  - script: node ./deploy-action/dist/index.cjs
    displayName: 'Deploy to Arc XP'
    env:
      INPUT_ORG_ID: ${{ parameters.orgId }}
      INPUT_API_KEY: ${{ parameters.apiKey }}
      INPUT_API_HOSTNAME: ${{ parameters.apiHostname }}
      INPUT_BUNDLE_PREFIX: ${{ parameters.bundlePrefix }}
      INPUT_PAGEBUILDER_VERSION: ${{ parameters.pagebuilderVersion }}
      INPUT_ARTIFACT: ${{ parameters.artifact }}
      INPUT_RETRY_COUNT: ${{ parameters.retryCount }}
      INPUT_RETRY_DELAY: ${{ parameters.retryDelay }}
      INPUT_MINIMUM_RUNNING_VERSIONS: ${{ parameters.minimumRunningVersions }}
      INPUT_TERMINATE_RETRY_COUNT: ${{ parameters.terminateRetryCount }}
      INPUT_TERMINATE_RETRY_DELAY: ${{ parameters.terminateRetryDelay }}
      INPUT_DEPLOY: ${{ parameters.deploy }}
      INPUT_PROMOTE: ${{ parameters.promote }}
